<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>
        <div>
            <label for="memAccount">帳號: </label>

            <label id="l1"></label>
        </div>
        <div>
            <label for="memPassword">密碼: </label>
            <a href="passwordChange.jsp" id="a1">更改密碼</a>
            <label id="l2"></label>
        </div>

        <div>
            <label for="memName">*帳戶名稱: </label>
            <input type="text" name="memName" id="memName">
            <label id="l4"></label>
        </div>
        <div>
            <label for="memMobile">*行動電話: </label>
            <input type="text" name="memMobile" id="memMobile">
            <label id="l5"></label>
        </div>

        <div>
            <label for="memCity">居住縣市: </label>
            <input type="text" name="memCity" id="memCity">
            <label id="s1"></label>
        </div>
        <div>
            <label for="memDist">鄉/鎮/市/區: </label>
            <input type="text" name="memDist" id="memDist">
            <label id="s2"></label>
        </div>

        <div>
            <label for="memAdd">地址: </label>
            <input type="text" name="memAdd" id="memAdd">
            <label id="l6"></label>
        </div>
        <div>
            <label for="memEmail">*E-mail: </label>
            <input type="text" name="memEmail" id="memEmail">
            <label id="l7"></label>
        </div>
        <div>
            <label for="memBirth">出生年月日: </label>
            <input type="text" name="memBirth" id="memBirth">
            <label id="d1"></label>
        </div>
        <div>

        </div>
        <div id="cred">
            <label for="creditcardNo1">信用卡卡號: </label>
            <input type=text name="creditcardNo1" size=4 value="" maxlength=4 id="creditcardNo1"> -
            <input type=text name="creditcardNo2" size=4 value="" maxlength=4 id="creditcardNo2"> -
            <input type=text name="creditcardNo3" size=4 value="" maxlength=4 id="creditcardNo3"> -
            <input type=text name="creditcardNo4" size=4 value="" maxlength=4 id="creditcardNo4">
            <label id="lup2"></label>
        </div>
        <div>
            <label for="creditcardDate1">信用卡到期年月: </label>
            <input type=text name="creditcardDate1" size=2 value="" maxlength=2 id="creditcardDate1"
                placeholder="    月">
            /
            <input type=text name="creditcardDate2" size=2 value="" maxlength=2 id="creditcardDate2" placeholder="西元年">
            <label id="lup3"></label>
        </div>
        <div>
            <label for="creditcardSecurityNo">信用卡安全碼: </label>
            <input type=text name="creditcardSecurityNo" size=3 value="" maxlength=3 id="creditcardSecurityNo">
            <label id="lup4"></label>
        </div>

        <div>
            <label for="bankAccount1">銀行帳號: </label>
            <input type=text name="bankAccount1" size=5 value="" maxlength=3 id="bankAccount1" placeholder="銀行代碼">
            <input type=text name="bankAccount2" size=25 value="" id="bankAccount2" placeholder="銀行帳戶">
            <label id="lup5"></label>
        </div>
        <div>
            <label for="bankAccountOwner">戶名: </label>
            <input type="text" name="bankAccountOwner" id="bankAccountOwner">
            <label id="lup6"></label>
        </div>

        <div id="divImg">
            <label for="myPic">會員大頭貼: </label>
            <img src="" id="img1" />
            <input type="file" name="myPic" accept="image/*" id="myPic">
            <label id="lup7"></label>
        </div>
        <div id="catch">
            <input type="hidden" id="reader">
        </div>
        <div>
            <button id="btn1" type="button" class="btn btn-primary">送出</button>
            <label id="l8"></label>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tw-city-selector@2.1.1/dist/tw-city-selector.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/CGA101G1/datetimepicker/jquery.datetimepicker.css" />
    <script src="/CGA101G1/datetimepicker/jquery.js"></script>
    <script src="/CGA101G1/datetimepicker/jquery.datetimepicker.full.js"></script>
    <script>

        $(document).ready(function init() {

            //信用卡卡號
            $('#creditcardNo1').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardNo1').val())) {
                    $('#lup2').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup2').text(``);
                }
            })
            $('#creditcardNo2').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardNo2').val())) {
                    $('#lup2').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup2').text(``);
                }
            })
            $('#creditcardNo3').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardNo3').val())) {
                    $('#lup2').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup2').text(``);
                }
            })
            $('#creditcardNo4').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardNo4').val())) {
                    $('#lup2').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup2').text(``);
                }
            })
            //信用卡日期
            $('#creditcardDate1').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardDate1').val())) {
                    $('#lup3').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup3').text(``);
                }
            })
            $('#creditcardDate2').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardDate2').val())) {
                    $('#lup3').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup3').text(``);
                }
            })
            //信用卡安全碼
            $('#creditcardSecurityNo').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#creditcardSecurityNo').val())) {
                    $('#lup4').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup4').text(``);
                }
            })
            //銀行
            $('#bankAccount1').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#bankAccount1').val())) {
                    $('#lup5').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup5').text(``);
                }
            })
            $('#bankAccount2').blur(() => {
                const r1 = /^\d+$/;
                if (!r1.test($('#bankAccount2').val())) {
                    $('#lup5').text(`請輸入阿拉伯數字`)
                } else {
                    $('#lup5').text(``);
                }
            })


            //秀出所有資料
            $.ajax({
                type: 'POST',
                url: "/CGA101G1/mem/MemSelfInfo",
                contentType: "application/json",
                success: data => {
                    let { memNo, memAccount, memName, memMobile, memEmail,
                        memCity, memDist, memAdd, memBirth, creditcardNo,
                        creditcardDate, creditcardSecurityNo, bankAccount,
                        bankAccountOwner
                    } = data;
                    //日期
                    $.datetimepicker.setLocale('zh'); // kr ko ja en
                    $('#memBirth').datetimepicker({
                        theme: '',          //theme: 'dark',
                        timepicker: false,   //timepicker: false,
                        step: 1,            //step: 60 (這是timepicker的預設間隔60分鐘)
                        format: 'Y-m-d ',
                        value: memBirth,
                        //disabledDates:    ['2022/06/08','2022/06/09','2022/06/10'], // 去除特定不含
                        //startDate:	        '2022/07/10',  // 起始日
                        //minDate:           '-1970-01-01', // 去除今日(不含)之前
                        //maxDate:           '+1970-01-01'  // 去除今日(不含)之後
                    });
                    var somedate2 = new Date();
                    $('#memBirth').datetimepicker({
                        beforeShowDay: function (date) {
                            if (date.getYear() > somedate2.getYear() ||
                                (date.getYear() == somedate2.getYear() && date.getMonth() > somedate2.getMonth()) ||
                                (date.getYear() == somedate2.getYear() && date.getMonth() == somedate2.getMonth() && date.getDate() > somedate2.getDate())
                            ) {
                                return [false, ""]
                            }
                            return [true, ""];
                        }
                    });
                    //給資料
                    $("#l1").html(memAccount);
                    $("#memName").val(memName);
                    $("#memMobile").val(memMobile);
                    $("#memEmail").val(memEmail);
                    $("#memCity").val(memCity);
                    // $("#memDist").append('<option value=1>test</option>');
                    // $('#memDist').data("value", memDist);
                    $("#memDist").val(memDist);
                    $("#memAdd").val(memAdd);
                    $("#memBirth").attr("value", memBirth);


                    $("#divImg").html(
                        `<label for="myPic">會員大頭貼: </label>
                        <img src="/CGA101G1/mem/MemSelfPicServlet?memNo=${memNo}" id="img1" />
                        <input type="file" name="myPic" id="myPic" onchange="pic()">
                        <label id="lup7"></label>`);
                    //                     /CGA101G1/bid/bidPicGetOneByProdPicNo
                }

            });

        }); // ready


        //上傳新圖片
        function pic() {
            let imgs = document.querySelector('#img1');
            let inputs = document.querySelector('#myPic');
            inputs = inputs.files[0];

            const url = URL.createObjectURL(inputs);
            imgs.src = url;

            let reader = new FileReader();
            reader.readAsDataURL(inputs)

            reader.onloadend = function () {
                var arr;
                arr = reader.result;
                $("#reader").val(arr);

            }
        }

        $("#btn1").click(() => {
            if ($('#reader').val().length !== 0) {
                //對base64做切割處理
                let imageBase64 = $('#reader').val();
                let index = imageBase64.indexOf(',');
                index = index + 1
                let str1 = imageBase64.substr(0, index);
                imageBase64 = imageBase64.replace(str1, "");
                //送資料到後端
                $.ajax({
                    type: 'POST',
                    url: "/CGA101G1/mem/MemPicEditServlet",
                    contentType: "application/json",
                    data: imageBase64
                })
            }
            if ($('#memName').val().length === 0 ||
                $('#memMobile').val().length === 0 ||
                $('#memEmail').val().length === 0
            ) {
                $('#l8').text(`*為必填欄位,尚有欄位未輸入`);
            } else {
                $.ajax({
                    type: 'POST',
                    url: "/CGA101G1/mem/MemEditServlet",
                    contentType: "application/json",
                    data:
                        JSON.stringify({
                            memAccount: l1.innerText,
                            memName: memName.value,
                            memMobile: memMobile.value,
                            memAdd: memAdd.value,
                            memEmail: memEmail.value,
                            memBirth: memBirth.value,
                            memCity: memCity.value,
                            memDist: memDist.value,
                            memBirth: memBirth.value,
                            creditcardNo: creditcardNo1.value + creditcardNo2.value + creditcardNo3.value + creditcardNo4.value,
                            creditcardDate: creditcardDate1.value + creditcardDate2.value,
                            creditcardSecurityNo: creditcardSecurityNo.value,
                            bankAccount: bankAccount1.value + '-' + bankAccount2.value,
                            bankAccountOwner: bankAccountOwner.value,
                        }),
                    success: data => {
                        const { successful, message } = data;
                        if (successful) {
                            alert(message);
                            // location = "index.html";
                        } else {
                            $("#l8").html(message);
                        }
                    }


                });



            }
        })

    </script>
</body>

</html>